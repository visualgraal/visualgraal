<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Visualgraal – See the invisible</title>
<script src="https://cdn.jsdelivr.net/npm/@huggingface/inference@2.0.0"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:#f5f7fa;color:#333;height:100vh;display:flex;flex-direction:column;overflow:hidden}
header{background:#fff;padding:12px 20px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center}
#logo{display:flex;align-items:center;gap:8px}
#logo img{width:28px;height:28px}
#logo span{font-weight:800;font-size:22px}
select{padding:8px 12px;border-radius:8px;border:1px solid #ccc}
#prompt-section{padding:16px;background:#fff;border-bottom:1px solid #ddd}
#prompt{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px;height:70px;resize:none}
#generate{width:100%;margin-top:10px;padding:14px;background:#2563eb;color:#fff;border:none;border-radius:8px;font-size:17px;font-weight:600;cursor:pointer}
#generate:disabled{background:#999;cursor:not-allowed}
#canvas-area{flex:1;display:flex;justify-content:center;align-items:center;padding:20px;overflow:auto}
canvas{background:#fff;border:1px solid #ddd;border-radius:12px;max-width:100%;max-height:100%;touch-action:none}
#tools{padding:16px;padding-bottom:env(safe-area-inset-bottom,70px);background:#fff;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
button{background:#e2e8f0;padding:12px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
button.active{background:#2563eb;color:#fff}
#color-picker{margin-top:8px}
#signature{position:fixed;bottom:env(safe-area-inset-bottom,20px);right:20px;background:rgba(37,99,235,0.1);padding:10px 20px;border-radius:20px;font-family:monospace;font-size:13px}
</style>
</head>
<body>
<header>
<div id="logo">
<img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgiIGhlaWdodD0iMjgiIHZpZXdCb3g9IjAgMCAyOCAyOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTQiIGN5PSIxNCIgcj0iMTQiIGZpbGw9IiMwMDAiLz4KPHBhdGggZD0iTTEzIDdMMTUgMTBMMTMgMTJMMTEgMTBMMTIgN0wxNCA1TDE2IDdMMTQgMTBMMTYgMTJMMTQgMTRMMTIgMTNaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4=" alt="V">
<span>Visualgraal</span>
</div>
<select onchange="document.documentElement.lang=this.value">
<option value="fr">FR</option>
<option value="en">EN</option>
<option value="es">ES</option>
<option value="de">DE</option>
</select>
</header>

<div id="prompt-section">
<textarea id="prompt" placeholder="Un dragon rouge dans un ciel violet au coucher du soleil, style aquarelle…"></textarea>
<button id="generate">Générer l'image (FLUX.1)</button>
</div>

<div id="canvas-area">
<canvas id="canvas" width="900" height="600"></canvas>
</div>

<div id="tools">
<button class="active" onclick="tool='pencil'">Pinceau</button>
<button onclick="tool='eraser'">Gomme</button>
<button onclick="ctx.clearRect(0,0,canvas.width,canvas.height)">Nouveau</button>
<button onclick="download()">Exporter PNG</button>
<input type="color" id="color" value="#2563eb" title="Couleur pinceau">
</div>

<div id="signature">Visualgraal<br><small>by Jean-Luc Battini</small></div>

<script>
// Token Hugging Face déjà intégré (le tien)
const hf = new HfInference("hf_mdmI£AMIWbgKSHzVduplnKMEmXWrZWgZgz");

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let tool = 'pencil';
let drawing = false;

ctx.lineWidth = 25;
ctx.lineCap = 'round';

// Couleur pinceau
document.getElementById('color').addEventListener('input', e => ctx.strokeStyle = e.target.value);

// Pinceau + Gomme (Mac & iPhone)
['mousedown','touchstart'].forEach(ev => canvas.addEventListener(ev, e => { drawing = true; startPos(e); }));
['mousemove','touchmove'].forEach(ev => canvas.addEventListener(ev, e => { if(drawing) drawLine(e); }));
['mouseup','mouseleave','touchend','touchcancel'].forEach(ev => canvas.addEventListener(ev, () => drawing = false));

function startPos(e) {
const rect = canvas.getBoundingClientRect();
const x = (e.clientX || e.touches[0].clientX) - rect.left;
const y = (e.clientY || e.touches[0].clientY) - rect.top;
ctx.beginPath();
ctx.moveTo(x, y);
}

function drawLine(e) {
e.preventDefault();
const rect = canvas.getBoundingClientRect();
const x = (e.clientX || e.touches[0].clientX) - rect.left;
const y = (e.clientY || e.touches[0].clientY) - rect.top;
if (tool === 'pencil') {
ctx.globalCompositeOperation = 'source-over';
ctx.lineTo(x, y);
ctx.stroke();
} else {
ctx.globalCompositeOperation = 'destination-out';
ctx.lineTo(x, y);
ctx.stroke();
}
}

function download() {
const a = document.createElement('a');
a.href = canvas.toDataURL();
a.download = 'visualgraal.png';
a.click();
}

// Vraie IA FLUX.1-schnell + fallback instantané
async function generateImage() {
const prompt = document.getElementById('prompt').value.trim() || 'masterpiece, beautiful landscape';
const btn = document.getElementById('generate');
btn.disabled = true;
btn.textContent = 'FLUX.1 en cours…';

try {
const response = await hf.textToImage({
model: 'black-forest-labs/FLUX.1-schnell',
inputs: prompt,
parameters: { width: 800, height: 600, num_inference_steps: 4 }
});
const img = new Image();
img.onload = () => { ctx.drawImage(img,0,0,canvas.width,canvas.height); btn.disabled=false; btn.textContent='Générer l\'image'; };
img.src = URL.createObjectURL(response);
} catch (e) {
// Fallback local instantané si jamais l’API est lente
const grad = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
grad.addColorStop(0, '#7c3aed');
grad.addColorStop(1, '#ec4899');
ctx.fillStyle = grad;
ctx.fillRect(0,0,canvas.width,canvas.height);
btn.disabled = false;
btn.textContent = 'Générer l\'image';
}
}
</script>
</body>
</html>
